#!/usr/bin/env node

'use strict';

const meow = require('meow');
const globby = require('globby');
const fs = require('fs');
const everylint = require('../lib').default;

function handleUnexpectedError(err) {
  console.error('\nOops! Something went wrong! :(');
  console.error(err);
  process.exit(2);
}

process.once('uncaughtException', handleUnexpectedError);
process.once('unhandledRejection', handleUnexpectedError);

// Array of possible errors
const errors = [];

// Indicates whether a given path is ignored via a .gitignore file.
const isIgnored = globby.gitignore.sync();

// TODO: Add more options to program
const help = `
  Lint everything with everylint
`;

const cli = meow({
  help,
  flags: {
    fix: 'boolean',
  }
});

const filenames = cli.input
  .reduce((globbed, arg) => {
    const matched = globby.sync(arg);
    const files = matched.length ? matched : [arg];
    return globbed.concat(files);
  }, [])
  .filter(file => !isIgnored(file));

// FIXME: Keep only uniq files

// Collect errors for files that does not exist
filenames.forEach(filename => {
  if (!fs.existsSync(filename)) {
    errors.push(filename + ' does not exist!');
  }
});

// If there's nothing to lint, create an error
if (filenames.length === 0) {
  errors.push('No files to lint!');
}

// If there are some errors, exit the process
if (errors.length) {
  console.error(errors.join('\n'));
  process.exit(2);
}

// FIXME: Create more descriptive external Node.js API
everylint(filenames);
